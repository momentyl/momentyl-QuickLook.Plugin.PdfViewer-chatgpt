name: Build and Pack (qlplugin)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]
    tags:
      - "v*"
      - "*.*.*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\NuGet\Cache
            ~\AppData\Local\NuGet\v3-cache
            ~\.nuget\packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.sln', '**/*.csproj', '**/packages.config') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore NuGet
        run: nuget restore QuickLook.Plugin.PdfViewer-Native.sln

      - name: Generate version files (with fallback if no tags)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          try {
            pwsh -NoProfile -ExecutionPolicy Bypass -File .\Scripts\update-version.ps1
            Write-Host "update-version.ps1 succeeded."
          } catch {
            Write-Warning "update-version.ps1 failed (likely no tags). Creating fallback GitVersion.cs + Metadata.config..."

            $sha = (git rev-parse --short HEAD).Trim()
            $tag = "0.0.0"
            $revision = "0.0.0-$sha"

            $text = @"
// This file is generated by GitHub Actions fallback

using System.Reflection;

[assembly: AssemblyVersion("$tag")]
[assembly: AssemblyInformationalVersion("$revision")]
"@
            $text | Out-File .\GitVersion.cs -Encoding utf8

            [xml]$xml = Get-Content .\QuickLook.Plugin.Metadata.Base.config
            $xml.Metadata.Version = $revision
            $xml.Save(".\QuickLook.Plugin.Metadata.config")
          }

      - name: Build (Release | x86)
        run: msbuild QuickLook.Plugin.PdfViewer-Native.sln /m /p:Configuration=Release /p:Platform=x86

      - name: Pack .qlplugin
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $outDir = Join-Path $PSScriptRoot "Build\Release"
          if (!(Test-Path $outDir)) {
            throw "Build output not found: $outDir"
          }

          $artifactName = "QuickLook.Plugin.PDFViewer-Native.qlplugin"
          Remove-Item $artifactName -Force -ErrorAction SilentlyContinue

          $files = Get-ChildItem -Path $outDir -File | Where-Object { $_.Extension -notin @(".pdb", ".xml") }
          if ($files.Count -eq 0) {
            throw "No files found in $outDir"
          }

          $zip = "QuickLook.Plugin.PDFViewer-Native.zip"
          Remove-Item $zip -Force -ErrorAction SilentlyContinue

          Compress-Archive -Path $files.FullName -DestinationPath $zip -Force
          Move-Item $zip $artifactName -Force

          Write-Host "Packed: $artifactName"
          Get-Item $artifactName | Format-List Name,Length,LastWriteTime

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickLook.Plugin.PDFViewer-Native
          path: QuickLook.Plugin.PDFViewer-Native.qlplugin

      # 可选：当推送 tag 时自动发 GitHub Release
      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: QuickLook.Plugin.PDFViewer-Native.qlplugin

name: Build and Pack (qlplugin)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*", "*.*.*" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet
        run: nuget restore QuickLook.Plugin.PdfViewer-Native.sln

      - name: Update version (fallback if no tags)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          try {
            .\Scripts\update-version.ps1
          } catch {
            Write-Warning "update-version.ps1 failed; falling back to SHA-based version."

            $tag = "0.0.0.0"
            $rev = "0.0.0-" + (git rev-parse --short HEAD).Trim()

            $lines = @(
              "// Generated by CI fallback",
              "using System.Reflection;",
              "[assembly: AssemblyVersion(`"$tag`")]",
              "[assembly: AssemblyInformationalVersion(`"$rev`")]"
            )
            ($lines -join "`r`n") | Out-File .\GitVersion.cs -Encoding utf8

            [xml]$xml = Get-Content .\QuickLook.Plugin.Metadata.Base.config
            $xml.Metadata.Version = $rev
            $xml.Save(".\QuickLook.Plugin.Metadata.config")
          }

      - name: Build (Release | x86)
        run: msbuild QuickLook.Plugin.PdfViewer-Native.sln /m /p:Configuration=Release /p:Platform=x86

      - name: Pack .qlplugin
        shell: pwsh
        run: .\Scripts\pack-zip.ps1

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickLook.Plugin.PDFViewer-Native
          path: QuickLook.Plugin.PDFViewer-Native.qlplugin

      - name: Create GitHub Release (tag only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: QuickLook.Plugin.PDFViewer-Native.qlplugin

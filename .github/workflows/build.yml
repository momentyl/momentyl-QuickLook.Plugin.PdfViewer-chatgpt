name: Build and Pack (qlplugin)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*", "*.*.*" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout (fetch tags + submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false   # 我们下面手动 update，出问题更好排查

      - name: Init submodules (QuickLook.Common)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git submodule sync --recursive
          git submodule update --init --recursive --depth 1
          git submodule status --recursive
          if (!(Test-Path ".\QuickLook.Common\QuickLook.Common.csproj")) {
            Write-Host "Directory listing for QuickLook.Common:"
            Get-ChildItem -Force ".\QuickLook.Common" | Format-Table
            throw "QuickLook.Common.csproj not found after submodule update."
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet
        run: nuget restore QuickLook.Plugin.PdfViewer-Native.sln

      - name: Generate version files (always valid)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $sha = (git rev-parse --short HEAD).Trim()

          # 如果是 tag 构建，优先用 tag 作为版本；否则用 0.0.0.<run_number>
          $tag = ""
          if ($env:GITHUB_REF -like "refs/tags/*") {
            $tag = $env:GITHUB_REF_NAME
          }

          # 去掉常见的 v 前缀，例如 v1.2.3
          if ($tag) { $tag = $tag.TrimStart("v","V") }

          # AssemblyVersion 必须是 major[.minor[.build[.revision]]]
          if ($tag -and ($tag -match '^\d+(\.\d+){0,3}$')) {
            $asmVer = $tag
            $infoVer = "$tag+$sha"
            $metaVer = "$tag+$sha"
          } else {
            # 用 run_number 生成一个永远合法的 AssemblyVersion（避免未来没有 tag 的情况）
            $run = [int]$env:GITHUB_RUN_NUMBER
            $asmVer = "0.0.0.$run"
            $infoVer = "0.0.0-ci.$run+$sha"
            $metaVer = $infoVer
          }

          $gitVersion = @"
// Generated by GitHub Actions
using System.Reflection;

[assembly: AssemblyVersion("$asmVer")]
[assembly: AssemblyInformationalVersion("$infoVer")]
"@
          $gitVersion | Out-File .\GitVersion.cs -Encoding utf8

          [xml]$xml = Get-Content .\QuickLook.Plugin.Metadata.Base.config
          $xml.Metadata.Version = $metaVer
          $xml.Save(".\QuickLook.Plugin.Metadata.config")

          Write-Host "AssemblyVersion: $asmVer"
          Write-Host "InformationalVersion: $infoVer"
          Write-Host "Metadata.Version: $metaVer"

      - name: Build (Release | x86)
        run: msbuild QuickLook.Plugin.PdfViewer-Native.sln /m /p:Configuration=Release /p:Platform=x86

      - name: Pack .qlplugin
        shell: pwsh
        run: .\Scripts\pack-zip.ps1

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickLook.Plugin.PDFViewer-Native
          path: QuickLook.Plugin.PDFViewer-Native.qlplugin

      - name: Create GitHub Release (tag only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: QuickLook.Plugin.PDFViewer-Native.qlplugin
